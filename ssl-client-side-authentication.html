<!DOCTYPE html>
<html lang="zh">
<head>
        <title>SSL 客户端验证 - I am HHB</title>
        <meta charset="utf-8" />

        <!-- UIKIT -->
        <link href="http://cdn.bootcss.com/uikit/2.0.0/css/uikit.min.css" rel="stylesheet">
        <script src="http://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://cdn.bootcss.com/uikit/2.0.0/js/uikit.min.js"></script>
        <!-- MyCSS -->
        <link rel="stylesheet/less" type="text/css" href="/theme/css/hhb-uikit.less">
        <link rel="stylesheet/less" type="text/css" href="/theme/css/code.css">
        <script src="http://cdn.bootcss.com/less.js/1.6.0/less.min.js"></script>
        <link href="http://fonts.googleapis.com/css?family=Nova+Script|Racing+Sans+One" rel="stylesheet" type="text/css">
        <!-- FEEDS -->
</head>

<body>
    <header class="hhb-banner">
        <hgroup>
            <h1 class="uk-heading-large"><a href="/">I am HHB</a></h1>
            <p>月亮哪去了</p>
        </hgroup>
    </header>
    <nav class="uk-navbar hhb-navbar">
        <ul class="uk-navbar-nav">
            <li class="uk-active"><a href="/category/articles.html">Articles</a></li>
            <li><a href="/category/life.html">Life</a></li>
            <li><a href="/category/notes.html">Notes</a></li>
        </ul>
        <!--
        <div class="uk-navbar-content uk-navbar-flip">
            <form class="uk-form uk-margin-remove uk-display-inline-block" action="">
                <input type="text" placeholder="Search" />
            </form>
        </div>
        -->
    </nav>

    <div class="hhb-content">
<article class="uk-article">
    <header>
        <h1 class="uk-article-title">
            <a class="hidden" href="/ssl-client-side-authentication.html" rel="bookmark"
                title="Permalink to SSL 客户端验证">SSL 客户端验证</a>
        </h1>
        <p class="uk-article-meta">Hongbo He · <abbr title="2016-09-27T04:00:00+08:00">2016-09-27 04:00</abbr></p>
        
    </header>
    <div class="entry-content">
        <p>对于自己的个人网站，安全要求没有那么重要。如果想对网站做一个简单的身份验证，可以有两种方式：</p>
<ol>
<li>直接在 Nginx 中配置一个简单的 <code>auth_basic</code> 形式的用户名 &amp; 密码；</li>
<li>或者使用本文要说的 <strong>SSL Client Side Authentication</strong>；</li>
</ol>
<p>注：由于 <strong>Client Side Authentication</strong> 太长，下文会用 <strong>CSA</strong> 这个缩写来代替。</p>
<h2>为什么用这个</h2>
<p>两个原因：</p>
<ol>
<li>安全。这个不用说了，只有拥有证书的人才能被认证，就排除了密码被破解的可能性；</li>
<li>方便。不用输入用户名密码什么的了啊；</li>
</ol>
<h2>配置过程</h2>
<p>首先需要明确，CSA 的配置过程和网站的 <strong>Server Side Authentication</strong> 是完全独立的，两者没有什么关系。</p>
<h3>环境准备</h3>
<p>安装 openssl 工具。</p>
<div class="highlight"><pre><span></span>brew install openssl
</pre></div>


<p>准备一个空目录。</p>
<div class="highlight"><pre><span></span>mkdir certs
<span class="nb">cd</span> certs
</pre></div>


<h3>创建根证书</h3>
<div class="highlight"><pre><span></span><span class="c1"># generate primary key</span>
openssl genrsa -des3 -out ca.key <span class="m">4096</span>
<span class="c1"># or if you don&#39;t want a password:</span>
openssl genrsa -out ca.key <span class="m">4096</span>
<span class="c1"># generate a cert</span>
openssl req -new -x509 -days <span class="m">365</span> -key ca.key -out ca.crt
</pre></div>


<p>生成 ca.crt 文件的时候会需要填写一些信息，看着填就好了，关系不大。我是这么填写的：</p>
<div class="highlight"><pre><span></span>$ openssl req -new -x509 -days <span class="m">365</span> -key ca.key -out ca.crt
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
------
Country Name <span class="o">(</span><span class="m">2</span> letter code<span class="o">)</span> <span class="o">[</span>AU<span class="o">]</span>:CN
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>Some-State<span class="o">]</span>:Beijing
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[]</span>:Beijing
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Internet Widgits Pty Ltd<span class="o">]</span>:
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[]</span>:Hongbo He
Common Name <span class="o">(</span>e.g. server FQDN or YOUR name<span class="o">)</span> <span class="o">[]</span>:Hongbo He
Email Address <span class="o">[]</span>:me@graycarl.me
</pre></div>


<p>然后生成的证书长这样：</p>
<p><img alt="cert-1" src="/fs/17-08-03-600e4f7a.png"></p>
<p>这里创建的 ca.crt 是会放到服务端的，接下来我们创建安装在客户端的证书。</p>
<h3>创建客户端证书</h3>
<p>首先是创建证书请求：</p>
<div class="highlight"><pre><span></span>openssl genrsa -out client.key <span class="m">4096</span>
openssl req -new -key client.key -out client.csr
</pre></div>


<p>这里同样会需要输入一些信息，看着输入就好。</p>
<p>然后使用 ca 证书进行签发：</p>
<div class="highlight"><pre><span></span>openssl x509 -req -days <span class="m">365</span> -in client.csr -CA ca.crt -CAkey ca.key -set_serial <span class="m">01</span> -out client.crt
</pre></div>


<p>这样就签发好了客户端证书 client.crt。</p>
<h3>安装客户端证书</h3>
<p>上一步产生的 <code>client.crt</code> 并不能直接安装，需要转成 PKCS 格式：</p>
<div class="highlight"><pre><span></span>openssl pkcs12 -export -clcerts -in client.crt -inkey client.key -out client.p12
</pre></div>


<p>这里的 client.p12 在 MacOS 上就可以直接双击安装到系统的 KeyChain 里面。</p>
<h3>部署到服务器</h3>
<p>服务端只需要一个 ca.crt 文件即可。</p>
<div class="highlight"><pre><span></span>scp sa.crt somebody@someserver:/etc/nginx/certs/client-auth-ca.crt
</pre></div>


<p>Nginx 中加入如下的配置：</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">...</span>
    <span class="s">ssl_client_certificate</span> <span class="s">/etc/nginx/certs/client-auth-ca.crt</span><span class="p">;</span>
    <span class="kn">ssl_verify_client</span> <span class="s">optional</span><span class="p">;</span>
    <span class="kn">...</span>
<span class="err">}</span>
</pre></div>


<p>其中 <code>ssl_verify_client</code> 的值可以是 <code>optional | on</code> 者两个：</p>
<ol>
<li>当选择 <code>on</code> 时会强制进行客户端认证，失败无法访问；</li>
<li>当选择 <code>optional</code> 的时候，认证是可选的，是否认证成功可以从 <code>$ssl_client_verify</code> 变量得知。</li>
</ol>
<p>比如，我们想要网站根目录是任意访问的，但是 <code>/admin</code> 路径下是需要认证才能访问的，就可以这么配置：</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">...</span>
    <span class="s">ssl_client_certificate</span> <span class="s">/etc/nginx/certs/client-auth-ca.crt</span><span class="p">;</span>
    <span class="kn">ssl_verify_client</span> <span class="s">optional</span><span class="p">;</span>
    <span class="kn">...</span>

    <span class="s">location</span> <span class="s">/admin</span> <span class="p">{</span>
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$ssl_client_verify</span> <span class="s">!=</span> <span class="s">SUCCESS)</span> <span class="p">{</span>
            <span class="kn">return</span> <span class="mi">401</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kn">proxy_pass</span> <span class="s">http://localhost:5000</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2>完成</h2>
<p>当打开网站且本机装有对应的客户端证书时，就会出现请求证书认证的提示框：</p>
<p><img alt="cert-2" src="/fs/17-08-03-704063d1.png"></p>
<p>点确定就可以通过认证啦。</p>
<h2>参考</h2>
<p><a href="https://gist.github.com/mtigas/952344">ClientSide SSL</a></p>
<p><a href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html">Nginx SSL Module</a></p>
    </div>
</section>
    </div>
    <hr/>
    <footer>
    <p>
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
    </p>
    </footer>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

</body>
</html>