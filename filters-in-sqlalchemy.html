<!DOCTYPE html>
<html lang="zh">
<head>
        <title>终于知道SQLAlchemy里面filter到底是怎么回事了 - I am HHB</title>
        <meta charset="utf-8" />

        <!-- UIKIT -->
        <link href="http://cdn.bootcss.com/uikit/2.0.0/css/uikit.min.css" rel="stylesheet">
        <script src="http://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://cdn.bootcss.com/uikit/2.0.0/js/uikit.min.js"></script>
        <!-- MyCSS -->
        <link rel="stylesheet/less" type="text/css" href="/theme/css/hhb-uikit.less">
        <link rel="stylesheet/less" type="text/css" href="/theme/css/code.css">
        <script src="http://cdn.bootcss.com/less.js/1.6.0/less.min.js"></script>
        <link href="http://fonts.googleapis.com/css?family=Nova+Script|Racing+Sans+One" rel="stylesheet" type="text/css">
        <!-- FEEDS -->
</head>

<body>
    <header class="hhb-banner">
        <hgroup>
            <h1 class="uk-heading-large"><a href="/">I am HHB</a></h1>
            <p>月亮哪去了</p>
        </hgroup>
    </header>
    <nav class="uk-navbar hhb-navbar">
        <ul class="uk-navbar-nav">
            <li class="uk-active"><a href="/category/articles.html">Articles</a></li>
            <li><a href="/category/life.html">Life</a></li>
            <li><a href="/category/notes.html">Notes</a></li>
        </ul>
        <!--
        <div class="uk-navbar-content uk-navbar-flip">
            <form class="uk-form uk-margin-remove uk-display-inline-block" action="">
                <input type="text" placeholder="Search" />
            </form>
        </div>
        -->
    </nav>

    <div class="hhb-content">
<article class="uk-article">
    <header>
        <h1 class="uk-article-title">
            <a class="hidden" href="/filters-in-sqlalchemy.html" rel="bookmark"
                title="Permalink to 终于知道SQLAlchemy里面filter到底是怎么回事了">终于知道SQLAlchemy里面filter到底是怎么回事了</a>
        </h1>
        <p class="uk-article-meta">Hongbo He · <abbr title="2012-10-07T23:42:00+08:00">2012-10-07 23:42</abbr></p>
        
    </header>
    <div class="entry-content">
        <p>之前一直对这个很迷惑，为什么SQLAlchemy的代码可以这么写</p>
<div class="highlight"><pre><span></span><span class="n">reply_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">CommentBase</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CommentBase</span><span class="o">.</span><span class="n">user_id</span><span class="o">==</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CommentBase</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)(</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CommentBase</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">id_list</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>


<p>那个扎眼的"=="难道不会直接把CommentBase.user_id和User.id比较出结果再传入filter函数吗，filter是怎么知道这个比较逻辑并生成对应的SQL语句的呢。</p>
<p>在网上找了好久也没有找到答案，因为我一直以为在function的内部是可以有方法得到该方法被调用的时候传入的表达式（表达式字串）的。</p>
<p>直到后来看到了StackOverFlow上的这么一条：</p>
<blockquote>
<p>What advantage is there to overriding the == operator in an ORM?</p>
<p>Apparently alot of ORM's do something like this:</p>
<div class="highlight"><pre><span></span>query.filter(username == &quot;bob&quot;)
</pre></div>


<p>to generate sql like</p>
<div class="highlight"><pre><span></span>... WHERE username = &#39;bob&#39;
</pre></div>


<p>Why override the == operator instead of something like:</p>
<div class="highlight"><pre><span></span>query.filter(username.eq(&quot;bob&quot;))
</pre></div>


</blockquote>
<p>这是一个提出的问题，不过不用看回答就已经解决我的疑惑了，我居然把运算法override这个概念给忘了，真个悲剧。</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; CommentBase.user_id == User.id
&lt;sqlalchemy.sql.expression._BinaryExpression object at 0x2bdfd50&gt;
</pre></div>


<p>一切都真相大白了。</p>
    </div>
</section>
    </div>
    <hr/>
    <footer>
    <p>
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
    </p>
    </footer>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

</body>
</html>