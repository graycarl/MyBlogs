<!DOCTYPE html>
<html lang="zh">
<head>
        <title>Python datetime and timezone - I am HHB</title>
        <meta charset="utf-8" />

        <!-- UIKIT -->
        <link href="http://cdn.bootcss.com/uikit/2.0.0/css/uikit.min.css" rel="stylesheet">
        <script src="http://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://cdn.bootcss.com/uikit/2.0.0/js/uikit.min.js"></script>
        <!-- MyCSS -->
        <link rel="stylesheet/less" type="text/css" href="/theme/css/hhb-uikit.less">
        <link rel="stylesheet/less" type="text/css" href="/theme/css/code.css">
        <script src="http://cdn.bootcss.com/less.js/1.6.0/less.min.js"></script>
        <link href="http://fonts.googleapis.com/css?family=Nova+Script|Racing+Sans+One" rel="stylesheet" type="text/css">
        <!-- FEEDS -->
</head>

<body>
    <header class="hhb-banner">
        <hgroup>
            <h1 class="uk-heading-large"><a href="/">I am HHB</a></h1>
            <p>月亮哪去了</p>
        </hgroup>
    </header>
    <nav class="uk-navbar hhb-navbar">
        <ul class="uk-navbar-nav">
            <li class="uk-active"><a href="/category/articles.html">Articles</a></li>
            <li><a href="/category/life.html">Life</a></li>
            <li><a href="/category/notes.html">Notes</a></li>
        </ul>
        <!--
        <div class="uk-navbar-content uk-navbar-flip">
            <form class="uk-form uk-margin-remove uk-display-inline-block" action="">
                <input type="text" placeholder="Search" />
            </form>
        </div>
        -->
    </nav>

    <div class="hhb-content">
<article class="uk-article">
    <header>
        <h1 class="uk-article-title">
            <a class="hidden" href="/python-datetime-and-timezone.html" rel="bookmark"
                title="Permalink to Python datetime and timezone">Python datetime and timezone</a>
        </h1>
        <p class="uk-article-meta">Hongbo He · <abbr title="2014-03-21T15:17:00+08:00">2014-03-21 15:17</abbr></p>
        
    </header>
    <div class="entry-content">
        <p>悲剧的发现之前一直都理解有误啊，仔细读了一遍文档，这里做个记录。</p>
<h2>基本类型</h2>
<p><code>datetime</code>库里面主要有这么五种数据：</p>
<ul>
<li>date</li>
<li>datetime</li>
<li>time</li>
<li>timedelta</li>
<li>tzinfo</li>
</ul>
<h3>date</h3>
<p><code>date</code>表示纯粹的日期数据，即“2020-02-21”这种，不含时区概念。</p>
<p>文档里面有这么一句：</p>
<blockquote>
<p>January 1 of year 1 is called day number 1, January 2 of year 1 is called day number 2, and so on.</p>
</blockquote>
<p>在加上<code>date.fromordinal</code>和<code>date.toorinal</code>这两个方法，我觉得其内部可能就是用<code>day number</code>这个整型数来表示的。不过这个无所谓啦。</p>
<h3>time</h3>
<p><code>time</code>表示时间数据，即”12:22:34”这种，但是它是<strong>可以</strong>有时区概念<code>time.tzinfo</code>在里面的。</p>
<p>关于Time Zone的东西下面会详细说，这里先不说了。</p>
<h3>datetime</h3>
<p><code>datetime</code>是<code>date</code>和<code>time</code>的结合体，表示完整的时间概念，即”2014-02-21 12:23:23”这种。也是<strong>可以</strong>有时区概念的。</p>
<p>另外，<code>datetime</code>是<code>date</code>的子类。</p>
<h3>timedelta</h3>
<p><code>timedelta</code>表示时间长度（时间差），很好理解，没啥好说的。</p>
<h3>tzinfo</h3>
<p>即Time Zone Info，时区信息。这个原始的<code>tzinfo</code>是一个抽象基类，不应该直接实例化，应该子类化并实现一些必要函数再使用。</p>
<p>需要实现的函数如下：</p>
<ul>
<li>tzinfo.utcoffset(self, dt)</li>
<li>tzinfo.dst(self, dt)</li>
<li>tzinfo.tzname(self, dt)</li>
</ul>
<p>待实现的这些函数主要都是用于被<code>datetime</code>或者<code>time</code>实例调用。逻辑会在下面说明。</p>
<h2>关于时区</h2>
<p>上面说到<code>datetime</code>和<code>time</code>是<strong>可以</strong>有时区概念的，为什么是<strong>可以</strong>有呢？</p>
<p>先从文档里面直接拿出两个名词：</p>
<blockquote>
<p>There are two kinds of date and time objects: “naive” and “aware”.</p>
</blockquote>
<p>“Naive” Object表示单纯的时间数据，不包含时区信息，所以无法直接进行时区转换等操作。</p>
<p>“Aware” Object表示包含了时区信息的时间数据，这其实才是真实世界中可以在时间轴上找到自己位置的对象。由于带有了时区信息，所以也就原生支持了各时区转换等操作。</p>
<p>同样是一个<code>datetime</code>(或者<code>time</code>)对象，当<code>datetime.tzinfo is None</code>时它就是”naive”的，否则<code>datetime.tzinfo</code>存放了时区信息，它就是”aware”的。</p>
<p>让一个naive对象变成aware对象最直接的方法就是给它设置一个<code>tzinfo</code>对象：</p>
<div class="highlight"><pre><span></span>n = datetime.now()
# 注意，replace方法只会直接修改属性值，不会自动根据时区做时间调整
n.replace(tzinfo=sometz)
</pre></div>


<p>如果对一个naive对象调用一些跟时区相关的方法(如: <code>datetime.astimezone</code>)，就会报错或无效，因为这些方案的实现中通常需要使用<code>datetime.tzinfo</code>中实现的方法。</p>
<p><code>tzinfo</code>只是一个抽象基类，定义了一些子类化时候需要实现的方案，在python的标准库里面没有任何实现。</p>
<p>可以为什么呢？标准库里面不应该有一些基本的通用的实现么。猜测估计是由于当前世界上各时区的混乱（还有夏令时这种奇葩的东西），以及各平台下时区信息的存储方式的差异，导致不适合在标准库里面实现吧。</p>
<p>实现一个最简单的UTC Time Zone如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">tzinfo</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="n">ZERO</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UTC</span><span class="p">(</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="c1"># 本时区与UTC时间的差值</span>
    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span>

    <span class="c1"># 时区名称</span>
    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="err">“</span><span class="n">UTC</span><span class="err">”</span>

    <span class="c1"># 夏令时</span>
    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span>
</pre></div>


<p>当然也没有必要真的就自己手动实现，使用<code>pytz</code>或者<code>dateutils</code>这些第三方库就好了。</p>
<h2>关于时间戳(TimeStamp)</h2>
<p>时间戳的含义就是UTC时间1970-01-01 00:00:00到当前时间的秒数，这本质上是一个时间差，所以没有时区的概念。</p>
<p>对于时间戳的操作，主要涉及的是另一个标准库<code>time</code>，注意这里的<code>time</code>并不是<code>datetime.time</code>。</p>
<p>获取当前时间戳:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="n">current_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>


<h2>使用Naive对象</h2>
<p>标准库里面没有实现<code>tzinfo</code>，所以如果我们没有使用第三方库，那么我们一定都是在使用<em>Naive</em>对象了。</p>
<p>但是，实际情况是即时我们使用的都是<em>Naive</em>对象，还是会有Local时间和UTC时间的区分！这就是我之前一直很混乱的地方。</p>
<p>其实，如果只需要做本地时间和UTC时间的转换是用不着<code>tzinfo</code>的。</p>
<h3>datetime.now([tzinfo])</h3>
<p><code>datetime.now</code>是一个类函数，返回表示当前时间的<code>datetime</code>对象。它有一个可选参数，可传入一个具体的时区信息来返回指定时区的当前时间。如果不带参数调用，那么它会返回本地时间的<em>naive</em>对象。</p>
<p>比如，我现在是北京时间<code>2014-03-21 14:11:00</code>:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">now</span>
<span class="mi">2014</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">21</span> <span class="mi">14</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mf">23.414917</span>
</pre></div>


<p>虽然返回的是本地时间（北京时间），但是它是<em>naive</em>对象，不带时区信息！</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; print now.tzinfo
None
</pre></div>


<p>如果想要得到UTC时间:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; utcnow = datetime.utcnow()
&gt;&gt;&gt; print utcnow
2014-03-21 06:16:10.025043
</pre></div>


<h3>datetime &lt;=&gt; timestamp</h3>
<p>本地时间和时间戳之间转换:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; now = datetime.now()
&gt;&gt;&gt; print now
2014-03-21 14:22:11
&gt;&gt;&gt; ts = time.mktime(now.timetuple())
&gt;&gt;&gt; print ts
1395382931.0
&gt;&gt;&gt; _now = datetime.fromtimestamp(ts)
&gt;&gt;&gt; print _now
2014-03-21 14:22:11
</pre></div>


<p>如果想把时间戳转成UTC时间:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; _utcnow = datetime.utcfromtimestamp(ts)
&gt;&gt;&gt; print _utcnow
2014-03-21 06:22:11
</pre></div>


<p>如果想把UTC时间转成时间戳:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; ts = time.mktimefromutc(datetime.utcnow().timetuple())
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
AttributeError: &#39;module&#39; object has no attribute &#39;mktimefromutc&#39;
</pre></div>


<p>好吧，总觉得<code>time</code>里面缺少这这么个函数，不过我们可以这么来：</p>
<div class="highlight"><pre><span></span>utcnow = datetime.utcnow()
ts_from_utcdt = time.mktime(utcnow.timetuple()) - time.timezone
</pre></div>


<p>或者:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">calendar</span>
<span class="n">ts_from_utcdt</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">utcnow</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
</pre></div>


<p>又用到了<code>calendar</code>这个库，真够乱的。</p>
<h3>Local DateTime &lt;=&gt; UTC DateTime</h3>
<p>对于naive对象，貌似没有方法能够直接支持本地时间和UTC时间转换的，所以只能从TimeStamp中绕一圈了。</p>
<p>Local DateTime =&gt; UTC DateTime</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; print now
2014-03-21 14:41:42.529159
&gt;&gt;&gt; ts = time.mktime(now.timetuple())
&gt;&gt;&gt; utcnow = datetime.utcfromtimestamp(ts)
&gt;&gt;&gt; print utcnow
2014-03-21 06:41:42
</pre></div>


<p>UTC DateTime =&gt; Local DateTime</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; utc = datetime.utcnow()
&gt;&gt;&gt; print utc
2014-03-21 06:44:15.069810
&gt;&gt;&gt; ts = time.mktime(utc.timetuple()) - time.timezone
&gt;&gt;&gt; local = datetime.fromtimestamp(ts)
&gt;&gt;&gt; print local
2014-03-21 14:44:15
</pre></div>


<h2>使用Aware对象</h2>
<p>如果使用<code>Aware</code>对象，一些貌似都清晰了不少。</p>
<h3>datetime.now([tzinfo])</h3>
<p>我们可以返回一个指定时区的<code>datetime</code></p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pytz</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tz_cn</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s2">&quot;Asia/Shanghai&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tz_us</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;America/Los_Angeles&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz_cn</span><span class="p">)</span>
<span class="mi">2014</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">21</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mf">38.059945</span><span class="o">+</span><span class="mi">08</span><span class="p">:</span><span class="mo">00</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz_us</span><span class="p">)</span>
<span class="mi">2014</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">20</span> <span class="mi">23</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mf">45.427634</span><span class="o">-</span><span class="mo">07</span><span class="p">:</span><span class="mo">00</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">UTC</span><span class="p">)</span>
<span class="mi">2014</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">21</span> <span class="mo">06</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mf">56.507517</span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>
</pre></div>


<p>并且它是<code>aware</code>的</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; dt_cn = datetime.now(tz_cn)
&gt;&gt;&gt; dt_cn.tzinfo
&lt;DstTzInfo &#39;Asia/Shanghai&#39; CST+8:00:00 STD&gt;
</pre></div>


<h3>时区转换</h3>
<p>对于<code>aware</code>对象之间的转换很简单:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; dt_cn = datetime.now(tz_cn)
&gt;&gt;&gt; print dt_cn
2014-03-21 15:04:21.700744+08:00
&gt;&gt;&gt; dt_us = dt_cn.astimezone(tz_us)
&gt;&gt;&gt; print dt_us
2014-03-21 00:04:21.700744-07:00
</pre></div>


<p>对于非<code>aware</code>的对象，可以先将其转换成<code>aware</code>的再操作：</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; dt_naive = datetime.utcnow()
&gt;&gt;&gt; print dt_naive
2014-03-21 07:05:58.194690
&gt;&gt;&gt; dt_utc = dt_naive.replace(tzinfo=pytz.UTC)
&gt;&gt;&gt; print dt_utc
2014-03-21 07:05:58.194690+00:00
&gt;&gt;&gt; dt_cn = dt_utc.astimezone(tz_cn)
&gt;&gt;&gt; print dt_cn
2014-03-21 15:05:58.194690+08:00
</pre></div>


<p>对于<code>aware</code>对象和时间戳的转换，我觉得还是全都转成UTC时间再操作吧。</p>
    </div>
</section>
    </div>
    <hr/>
    <footer>
    <p>
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
    </p>
    </footer>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

</body>
</html>